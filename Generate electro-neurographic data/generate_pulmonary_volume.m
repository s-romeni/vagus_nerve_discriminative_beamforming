clc
clear 
close all
%%-------------------------------------------------------------------------
% General info: generate synthetic respiration signal using a simple
% lumped parameters model
%%-------------------------------------------------------------------------
% The scripts is the implementation of the following bibliographic source:
% A. R. Plummer et al., “A simple method to estimate flow restriction for 
% dual ventilation of dissimilar patients: The BathRC model,” PLoS ONE, 
% vol. 15, no. 11, p. e0242123, Nov. 2020, doi: 10.1371/journal.pone.0242123.
%%-------------------------------------------------------------------------
% Authors: 
%%-------------------------------------------------------------------------
% Andrea Pitzus @TNE, SSSA // @MeDSP, UniCa & Simone Romeni @TNE, EPFL
%%-------------------------------------------------------------------------

%%-------------------------------------------------------------------------
% Time
%%-------------------------------------------------------------------------
dt = 0.025*1e-3;
t = (dt:dt:40)';
duri = 1;
dure1 = 2*duri;
dure2 = 0.65;
ti = t(1:duri*(1/dt));
te1 = t(1:dure1*(1/dt));
te2 = t(1:dure2*(1/dt));
%%-------------------------------------------------------------------------
% Inspiration Resistance 
%%-------------------------------------------------------------------------
Ri = 13; % cmH20/(L/s)
%%-------------------------------------------------------------------------
% Espiration Resistance 
%%-------------------------------------------------------------------------
Re = 13; % cmH20/(L/s)
%%-------------------------------------------------------------------------
% Inspiration Compliance
%%-------------------------------------------------------------------------
Ci = 0.054; % L/cmH20
%%-------------------------------------------------------------------------
% Espiration Compliance 
%%-------------------------------------------------------------------------
Ce = 0.054; % L/cmH20
%%-------------------------------------------------------------------------
% Time Constant
%%-------------------------------------------------------------------------
taui = Ri*Ci;
taue = Re*Ce;
%%-------------------------------------------------------------------------
% Pressure Inspiration
%%-------------------------------------------------------------------------
Pi = 56; % cmH20
%%-------------------------------------------------------------------------
% Pressure Espiration
%%-------------------------------------------------------------------------
Pe = 45; % cmH20
%%-------------------------------------------------------------------------
% Volume inspiration steady state
%%-------------------------------------------------------------------------
Vi = Ci*Pi; % L
%%-------------------------------------------------------------------------
% Volume espiration steady state
%%-------------------------------------------------------------------------
Ve = Ce*Pe; % L
%%-------------------------------------------------------------------------
b = exp(-duri/taui);
a = Ci*(1-b);
d = exp(-dure1/taue);
c = Ce*(1-d);
%%-------------------------------------------------------------------------
% Maximum Volume
Vmax = (a*Pi + b*c*Pe)/(1 - b*d); % L
%%-------------------------------------------------------------------------
% Minimum Volume
Vmin = (a*d*Pi + c*Pe)/(1 - b*d); % L
%%-------------------------------------------------------------------------

%%-------------------------------------------------------------------------
% Inspiration
%%-------------------------------------------------------------------------
V = Vi - (Vi - Vmin)*exp(-ti/taui);
%%-------------------------------------------------------------------------
% Espiration
%%-------------------------------------------------------------------------
V = [V; Ve + (Vmax - Ve)*exp(-te1/taue)];
V = [V; V(end)*ones(length(te2),1)];
%%-------------------------------------------------------------------------
% Check
%%-------------------------------------------------------------------------
% figure
% plot([ti;ti(end)+te1;ti(end)+te1(end)+te2],V)
%%-------------------------------------------------------------------------
V = repmat(V,[12 1]);
resp = V(1:length(t));
save('syn_resp.mat','resp','t')
%%-------------------------------------------------------------------------